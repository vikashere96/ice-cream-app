<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Ice Cream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* Ensure enough space for bottom navbar */
        body {
            padding-bottom: 120px;
        }

        /* Make sure last items are accessible */
        .menu-item:last-child {
            margin-bottom: 100px !important;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        

    </style>
</head>

<body class="bg-gray-950 text-white font-sans">
    {% csrf_token %}

    <!-- Hero / Welcome Section -->
    <section class="relative min-h-[60vh] overflow-hidden">
        <!-- Floating Orbs -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="floating-orb orb-1"></div>
            <div class="floating-orb orb-2"></div>
            <div class="floating-orb orb-3"></div>
            <div class="floating-orb orb-4"></div>
            <div class="floating-orb orb-5"></div>
        </div>
        <div class="relative z-10 flex flex-col items-center justify-center text-center px-6 pt-20 pb-16">
            <span class="inline-flex items-center space-x-2 mb-3 text-indigo-300/80">
                <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                <span class="text-sm tracking-wide">Table {{ table.number }}</span>
            </span>
            <h1
                class="text-4xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 via-fuchsia-300 to-pink-300">
                Welcome to Ice Cream Shop
            </h1>
            <p class="mt-3 text-white/70 max-w-2xl">Fresh scoops, creamy swirls, and your favorite flavors ‚Äî made with
                love. Tap below to start your order.</p>
            <button onclick="scrollToMenu()"
                class="mt-8 px-8 py-3 rounded-full bg-indigo-600 hover:bg-indigo-500 transition shadow-lg shadow-indigo-600/30">
                Start Order
            </button>
        </div>
    </section>

    <!-- Menu Grid -->
    <div id="menu" class="container mx-auto px-4 pb-64 md:pb-60"></div>
    

    
    <!-- Personalize Section -->
    <div class="rounded-2xl bg-white/5 border border-white/10 backdrop-blur-md p-5 mb-6">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Personalize your scoop</h3>
            <div class="flex space-x-2">
                <button id="clearPrefs" class="text-xs text-white/70 hover:text-white"
                    onclick="clearPreferences()">Clear</button>
                <button onclick="testRecommendations()" class="text-xs text-blue-400 hover:text-blue-300"
                    title="Test AI Recommendations">ü§ñ Test AI</button>
            </div>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
            <div>
                <div class="text-sm text-white/70 mb-2">Mood</div>
                <div class="flex flex-wrap gap-2" id="pref-mood">
                    <button class="chip" data-group="mood" data-value="happy">üòä Happy</button>
                    <button class="chip" data-group="mood" data-value="stressed">üòµ Stressed</button>
                    <button class="chip" data-group="mood" data-value="adventurous">ü§† Adventurous</button>
                    <button class="chip" data-group="mood" data-value="celebrating">üéâ Celebrating</button>
                </div>
            </div>
            <div>
                <div class="text-sm text-white/70 mb-2">Flavors you like (multi-select)</div>
                <div class="flex flex-wrap gap-2" id="pref-flavor">
                    <button class="chip" data-group="flavor" data-value="fruity">üçì Fruity</button>
                    <button class="chip" data-group="flavor" data-value="nutty">ü•ú Nutty</button>
                    <button class="chip" data-group="flavor" data-value="floral">üå∏ Floral</button>
                    <button class="chip" data-group="flavor" data-value="minty">üåø Minty</button>
                    <button class="chip" data-group="flavor" data-value="rich">üç´ Rich & creamy</button>
                </div>
            </div>
            <div>
                <div class="text-sm text-white/70 mb-2">Weather & vibe</div>
                <div class="flex flex-wrap gap-2" id="pref-vibe">
                    <button class="chip" data-group="vibe" data-value="hot">‚òÄÔ∏è Hot day</button>
                    <button class="chip" data-group="vibe" data-value="light">üïäÔ∏è Light</button>
                    <button class="chip" data-group="vibe" data-value="classic">‚≠ê Classic</button>
                </div>
            </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-white/70">We‚Äôll suggest based on your choices</div>
            <button class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition"
                onclick="computeSuggestions()">Suggest for me</button>
        </div>
    </div>

    <!-- Suggestions Row -->
    <div id="suggestions" class="hidden mb-6">
        <h4 class="text-md font-semibold mb-3">Recommended for you</h4>
        <div id="suggestion-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <h2 class="text-2xl font-semibold mb-4">Popular Flavors</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
    {% for ice_cream in ice_creams %}

    <div class="relative">
        <img src="{% if ice_cream.image %}{{ ice_cream.image.url }}{% else %}data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY3ZWVhIi8+PHRleHQgeD0iNTAlIiB5PSI0MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0OCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfjaY8L3RleHQ+PHRleHQgeD0iNTAlIiB5PSI2NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPnt7IGljZV9jcmVhbS5uYW1lIH19PC90ZXh0Pjwvc3ZnPg=={% endif %}" alt="{{ ice_cream.name }}" class="w-full h-48 object-cover" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY3ZWVhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI2NCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfjaY8L3RleHQ+PC9zdmc+'; this.onerror=null;">
        <div
            class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent opacity-0 group-hover:opacity-100 transition">
        </div>
        <div class="absolute top-3 left-3 px-3 py-1 rounded-full text-xs bg-black/50 border border-white/10">
            ‚Çπ{{ ice_cream.price }}</div>
    </div>
    <div class="p-4">
        <h3 class="text-lg font-semibold">{{ ice_cream.name }}</h3>
        <div class="mt-4 flex items-center justify-between">
            <button class="px-4 py-2 rounded-lg bg-emerald-500/90 hover:bg-emerald-500 text-white transition"
                onclick="addToCart('{{ ice_cream.id }}','{{ ice_cream.name }}','{{ ice_cream.price }}')">
                Add
            </button>
            <div class="text-sm text-white/60 hidden" id="added-{{ ice_cream.id }}">Added to cart ‚úì</div>
        </div>
    </div>
    </div>
    {% endfor %}
    </div>
    </div>

    <!-- Google Login Section -->
    <div id="google-signin-section" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div
            class="bg-gray-900 border border-white/10 rounded-2xl p-4 sm:p-6 md:p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Welcome to Ice Cream Shop</h2>
                <p class="text-white/70 mb-6">Please sign in with Google to place your order securely</p>

                <!-- Email Entry Form -->
                <div class="space-y-6">
                    <!-- Important Notice -->
                    <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-4">
                        <div class="flex items-start space-x-3">
                            <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h4 class="text-blue-300 font-medium mb-1">Important Notice</h4>
                                <p class="text-blue-200 text-sm">Please enter your legitimate email address. This email
                                    will be used for:</p>
                                <ul class="text-blue-200 text-sm mt-2 space-y-1">
                                    <li>‚Ä¢ Order confirmation and receipt</li>
                                    <li>‚Ä¢ Payment notifications</li>
                                    <li>‚Ä¢ Billing and refund processing</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Email Input -->
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">
                            Email Address <span class="text-red-400">*</span>
                        </label>
                        <input type="email" id="customer-email-input"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition"
                            placeholder="your-email@example.com" required>
                        <p class="text-white/60 text-xs mt-1">This will be your billing email address</p>
                    </div>

                    <!-- Name Input -->
                    <div>
                        <label class="block text-white/90 text-sm font-medium mb-2">
                            Full Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" id="customer-name-input"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition"
                            placeholder="Your Full Name" required>
                        <p class="text-white/60 text-xs mt-1">Name for order confirmation</p>
                    </div>

                    <!-- Submit Button -->
                    <button onclick="emailLogin()"
                        class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-lg text-white font-medium transition-all duration-200 transform hover:scale-[1.02]">
                        Continue with Email Verification
                    </button>

                    <!-- Test Account Option -->
                    <!-- Test account option removed for production -->
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Info Display (Hidden Initially) -->
    <div id="customer-info" class="hidden fixed top-4 left-4 z-40">
        <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-lg p-3 flex items-center space-x-3">
            <img id="customer-pic" src="" alt="Customer" class="w-8 h-8 rounded-full">
            <span id="customer-name" class="text-white text-sm font-medium"></span>
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="email-verification-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
        <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-md mx-4 w-full">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">Verify Your Email</h3>
                <p class="text-white/70 mb-4">We've sent a 6-digit code to <span id="verification-email"
                        class="font-medium"></span></p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-white/80 text-sm font-medium mb-2">Enter Verification Code</label>
                    <input type="text" id="verification-code" maxlength="6"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white text-center text-2xl tracking-widest font-mono"
                        placeholder="000000">
                </div>

                <button onclick="verifyEmail()"
                    class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-medium transition">
                    Verify Email
                </button>

                <div class="text-center">
                    <button onclick="resendVerification()" class="text-blue-400 hover:text-blue-300 text-sm">
                        Didn't receive code? Resend
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google OAuth script removed to prevent 400 errors -->
    <script>
        let currentUserEmail = '';
        let emailVerified = {% if email_verified %}true{% else %} false{% endif %};
        let customerName = '{{ customer_name|default:"" }}';
        let customerEmail = '{{ customer_email|default:"" }}';

        // Check if customer is already logged in when page loads
        document.addEventListener('DOMContentLoaded', function () {
            const sessionCustomerName = '{{ customer_name|default:"" }}';
            const sessionEmailVerified = {% if email_verified %}true{% else %}false{% endif %};

        console.log('Page load - Customer name:', sessionCustomerName);
        console.log('Page load - Email verified:', sessionEmailVerified);

        if (sessionCustomerName && sessionEmailVerified) {
            emailVerified = true;
            showOrderInterface({
                name: sessionCustomerName,
                email: '{{ customer_email|default:"" }}',
                picture: '{{ customer_picture|default:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzY2N2VlYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNmZmZmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GkPC90ZXh0Pjwvc3ZnPg==" }}'
            });
        }
        });

        function showOrderInterface(data) {
            // Update global variables for Razorpay
            customerName = data.name || 'Customer';
            customerEmail = data.email || customerEmail || 'customer@example.com';

            console.log('Updated global variables - Name:', customerName, 'Email:', customerEmail);

            // Safely hide/show elements only if they exist
            const googleSigninSection = document.getElementById('google-signin-section');
            const orderUI = document.getElementById('order-ui');
            const customerInfo = document.getElementById('customer-info');
            const customerNameElement = document.getElementById('customer-name');
            const customerPic = document.getElementById('customer-pic');

            if (googleSigninSection) googleSigninSection.classList.add('hidden');
            if (orderUI) orderUI.classList.remove('hidden');
            if (customerInfo) customerInfo.classList.remove('hidden');
            if (customerNameElement) customerNameElement.innerText = data.name || 'Customer';
            if (customerPic) {
                if (data.picture && !data.picture.includes('data:image/svg+xml')) {
                    customerPic.src = data.picture;
                } else {
                    // Use a nice SVG avatar
                    customerPic.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(data.name || 'Customer')}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50`;
                }
            }

            emailVerified = true;
            console.log('Order interface shown, emailVerified set to:', emailVerified);
        }

        function verifyEmail() {
            const code = document.getElementById('verification-code').value.trim();

            if (code.length !== 6) {
                alert('Please enter a 6-digit code');
                return;
            }

            // Check for development test code first
            if (code === '123456') {
                emailVerified = true;
                document.getElementById('email-verification-modal').classList.add('hidden');
                document.getElementById('email-verification-modal').classList.remove('flex');
                // Check if customer is already logged in from session
                const sessionCustomerName = '{{ customer_name|default:"" }}';
                const sessionCustomerPicture = '{{ customer_picture|default:"" }}';

                console.log('Session customer name:', sessionCustomerName);
                console.log('Session customer picture:', sessionCustomerPicture);

                if (sessionCustomerName) {
                    showOrderInterface({
                        name: sessionCustomerName,
                        email: '{{ customer_email|default:"" }}',
                        picture: sessionCustomerPicture || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzY2N2VlYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNmZmZmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GkPC90ZXh0Pjwvc3ZnPg=='
                    });
                } else {
                    showOrderInterface({
                        name: 'Guest',
                        email: '',
                        picture: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzY2N2VlYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNmZmZmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GkPC90ZXh0Pjwvc3ZnPg=='
                    });
                }
                alert('Email verified successfully! You can now place your order.');
                return;
            }

            // Real verification for production
            fetch('/customer/verify-email/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    email: currentUserEmail,
                    code: code
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        emailVerified = true;

                        // Hide verification modal
                        document.getElementById('email-verification-modal').classList.add('hidden');
                        document.getElementById('email-verification-modal').classList.remove('flex');

                        // Show order interface
                        showOrderInterface({
                            name: data.name || 'Guest',
                            email: data.email || currentUserEmail || '',
                            picture: data.picture || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzY2N2VlYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiNmZmZmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7wn5GkPC90ZXh0Pjwvc3ZnPg=='
                        });

                        alert('Email verified successfully! You can now place your order.');
                    } else {
                        alert('Verification failed: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Verification error:', error);
                    alert('Verification failed. Please try again.');
                });
        }

        function resendVerification() {
            fetch('/customer/resend-verification/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ email: currentUserEmail })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Verification code resent! Please check your email.');
                    } else {
                        alert('Failed to resend: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Resend error:', error);
                    alert('Failed to resend. Please try again.');
                });
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <!-- Floating Navbar -->
    <div id="bottom-navbar" class="fixed bottom-0 left-0 w-full px-4 pb-4 pointer-events-none">
        <div class="container mx-auto">
            <div
                class="pointer-events-auto flex items-center justify-between bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl px-4 py-3 shadow-xl">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                    <div class="text-sm"><span id="item-count" class="font-bold">0</span> items</div>
                </div>
                <div class="flex items-center space-x-2">
                    <button
                        class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 border border-white/20 text-white transition"
                        onclick="toggleCartModal()">View Cart</button>
                    <button class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition"
                        onclick="toggleCartModal()">Place Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black/60 hidden items-stretch justify-center z-50">
        <div
            class="w-full h-full md:h-auto md:max-w-md md:my-8 rounded-none md:rounded-2xl overflow-hidden bg-gray-900 border border-white/10 shadow-2xl flex flex-col animate-[fadeIn_.25s_ease]">
            <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
                <h2 class="text-xl font-semibold">Your Order</h2>
                <button class="text-white/60 hover:text-white" onclick="toggleCartModal()">‚úï</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto divide-y divide-white/10"></div>
            <div class="px-5 py-4 border-t border-white/10">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-white/70">Total</div>
                    <div class="text-xl font-bold">‚Çπ<span id="total-price">0.00</span></div>
                </div>
                <div class="text-center text-white/60 text-sm mb-2">Slide to place order with Razorpay</div>
                <div class="slider" id="slideToPay">
                    <div class="slider-track"></div>
                    <div class="slider-label">Slide to Pay</div>
                    <div class="slider-handle" onmousedown="startSlide(event)" ontouchstart="startSlide(event)">¬ª</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader (hidden by default) -->
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="lds-ring">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <style>
        /* Hero floating orbs */
        /* Chips */
        .chip {
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            font-size: 14px;
        }

        .chip.active {
            background: rgba(99, 102, 241, .25);
            border-color: rgba(99, 102, 241, .5);
        }

        .floating-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(8px);
            opacity: .6;
        }

        .orb-1 {
            width: 160px;
            height: 160px;
            left: 10%;
            top: 10%;
            background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, .5), rgba(168, 85, 247, .25));
            animation: float 8s ease-in-out infinite;
        }

        .orb-2 {
            width: 220px;
            height: 220px;
            right: 15%;
            top: 20%;
            background: radial-gradient(circle at 30% 30%, rgba(236, 72, 153, .5), rgba(59, 130, 246, .25));
            animation: float 10s ease-in-out infinite 1s;
        }

        .orb-3 {
            width: 120px;
            height: 120px;
            left: 20%;
            bottom: 15%;
            background: radial-gradient(circle at 30% 30%, rgba(16, 185, 129, .5), rgba(99, 102, 241, .25));
            animation: float 9s ease-in-out infinite 2s;
        }

        .orb-4 {
            width: 180px;
            height: 180px;
            right: 20%;
            bottom: 10%;
            background: radial-gradient(circle at 30% 30%, rgba(14, 165, 233, .5), rgba(236, 72, 153, .25));
            animation: float 11s ease-in-out infinite 3s;
        }

        .orb-5 {
            width: 90px;
            height: 90px;
            left: 50%;
            top: 55%;
            background: radial-gradient(circle at 30% 30%, rgba(234, 179, 8, .5), rgba(16, 185, 129, .25));
            animation: float 7s ease-in-out infinite 1.5s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-20px)
            }
        }

        /* Slider */
        .slider {
            position: relative;
            height: 56px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            overflow: hidden;
            user-select: none;
        }

        .slider-track {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(90deg, rgba(99, 102, 241, .35), rgba(168, 85, 247, .35));
            transition: width .1s;
        }

        .slider-label {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            color: rgba(255, 255, 255, 0.75);
            font-weight: 600;
            letter-spacing: .3px;
            pointer-events: none;
        }

        .slider-handle {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            transition: transform .1s;
            backdrop-filter: blur(6px);
        }

        .slider-handle:active {
            transform: scale(.98);
        }

        /* Loader CSS from loading.io */
        .lds-ring {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }

        .lds-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 64px;
            height: 64px;
            margin: 8px;
            border: 8px solid #3498db;
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #3498db transparent transparent transparent;
        }

        .lds-ring div:nth-child(1) {
            animation-delay: -0.45s;
        }

        .lds-ring div:nth-child(2) {
            animation-delay: -0.3s;
        }

        .lds-ring div:nth-child(3) {
            animation-delay: -0.15s;
        }

        @keyframes lds-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <form id="csrf-form" style="display:none;">{% csrf_token %}</form>

    <script>
        let cart = {};
        let sliding = false;
        let slideData = null;
        const preferences = { mood: new Set(), flavor: new Set(), vibe: new Set() };

        function scrollToMenu() {
            document.getElementById('menu').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function addToCart(id, name, price) {
            const item = cart[id] || { quantity: 0, name, price: parseFloat(price) };
            item.quantity += 1;
            cart[id] = item;
            const added = document.getElementById(`added-${id}`);
            if (added) { added.classList.remove('hidden'); setTimeout(() => added.classList.add('hidden'), 1200); }
            updateNavbar();
        }

        function updateNavbar() {
            const itemCount = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            const navbar = document.getElementById('bottom-navbar');
            if (itemCount > 0) {
                document.getElementById('item-count').textContent = itemCount;
                navbar.classList.remove('translate-y-full');
            } else {
                navbar.classList.add('translate-y-full');
            }
        }

        function toggleCartModal() {
            const modal = document.getElementById('cart-modal');
            const cartItemsContainer = document.getElementById('cart-items');
            const totalPriceElement = document.getElementById('total-price');

            cartItemsContainer.innerHTML = '';
            let totalPrice = 0;

            for (const [id, item] of Object.entries(cart)) {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center justify-between px-5 py-3';
                itemElement.innerHTML = `
                    <div>
                        <div class="font-medium">${item.name}</div>
                        <div class="text-sm text-white/60">‚Çπ${item.price.toFixed(2)} each</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button class="w-8 h-8 rounded-full bg-white/10 border border-white/20 hover:bg-white/20" onclick="changeItemQty('${id}', -1)">-</button>
                        <div class="min-w-[2ch] text-center">${item.quantity}</div>
                        <button class="w-8 h-8 rounded-full bg-white/10 border border-white/20 hover:bg-white/20" onclick="changeItemQty('${id}', 1)">+</button>
                        <div class="w-20 text-right font-medium">‚Çπ${(item.quantity * item.price).toFixed(2)}</div>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
                totalPrice += item.quantity * item.price;
            }

            totalPriceElement.textContent = totalPrice.toFixed(2);
            modal.classList.toggle('hidden');
        }

        function changeItemQty(id, delta) {
            if (!cart[id]) return;
            cart[id].quantity += delta;
            if (cart[id].quantity <= 0) delete cart[id];
            updateNavbar();
            // Refresh cart content if open
            const modal = document.getElementById('cart-modal');
            if (!modal.classList.contains('hidden')) toggleCartModal(), toggleCartModal();
        }

        // Preferences UI
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.chip');
            if (!btn) return;
            const group = btn.dataset.group; const value = btn.dataset.value;
            if (group === 'mood') { // single-select for mood
                document.querySelectorAll('#pref-mood .chip').forEach(c => c.classList.remove('active'));
                preferences.mood.clear();
                btn.classList.add('active'); preferences.mood.add(value);
            } else { // multi-select
                if (btn.classList.contains('active')) { btn.classList.remove('active'); preferences[group].delete(value); }
                else { btn.classList.add('active'); preferences[group].add(value); }
            }
        });

        function clearPreferences() {
            ['pref-mood', 'pref-flavor', 'pref-vibe'].forEach(id => document.querySelectorAll(`#${id} .chip`).forEach(c => c.classList.remove('active')));
            preferences.mood.clear(); preferences.flavor.clear(); preferences.vibe.clear();
            document.getElementById('suggestions').classList.add('hidden');
            document.getElementById('suggestion-cards').innerHTML = '';
        }

        // Manual trigger for testing recommendations
        function testRecommendations() {
            console.log('Testing recommendations manually...');
            computeSuggestions();
        }

        function computeSuggestions() {
            console.log('Computing suggestions with preferences:', preferences);
            // Simple rule-based scoring using flavor keywords in names
            const flavorTags = {
                fruity: [/mango/i, /straw|berry/i],
                nutty: [/pista|pistach/i, /kesar/i],
                floral: [/gulkand/i, /paan/i, /rose/i],
                minty: [/mint/i, /paan/i],
                rich: [/kesar|pista|choco|chocolate|cream/i]
            };
            const moodBoost = {
                happy: { fruity: 2, rich: 1 },
                stressed: { floral: 2, rich: 2 },
                adventurous: { floral: 2, minty: 2 },
                celebrating: { rich: 3 }
            };
            const vibeBoost = { hot: { fruity: 2, minty: 2 }, light: { fruity: 2, floral: 1 }, classic: { rich: 2, nutty: 1 } };

            // Build a list from DOM (name, price, id, image)
            const cards = Array.from(document.querySelectorAll('#menu .grid > div'));
            const products = cards.map(card => {
                const img = card.querySelector('img');
                const name = card.querySelector('h3, h2')?.textContent?.trim() || card.querySelector('h2')?.textContent?.trim();
                const priceText = card.querySelector('div.relative .absolute, .px-3.py-1')?.textContent || card.querySelector('div .absolute')?.textContent || '';
                const priceMatch = priceText.match(/([0-9]+(?:\.[0-9]+)?)/);
                const price = priceMatch ? parseFloat(priceMatch[1]) : 0;
                const addBtn = card.querySelector('button[onclick^="addToCart("]');
                const idMatch = addBtn?.getAttribute('onclick')?.match(/addToCart\('\s*([^']+)/);
                const id = idMatch ? idMatch[1] : null;
                const image = img?.src || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY3ZWVhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0OCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfjaY8L3RleHQ+PC9zdmc+';
                return { id, name, price, image, el: card };
            }).filter(p => p.id && p.name && p.price > 0);

            console.log('Found products for recommendations:', products);

            const mood = Array.from(preferences.mood)[0];
            const fl = Array.from(preferences.flavor);
            const vb = Array.from(preferences.vibe);

            const scores = products.map(p => {
                let score = 0;
                // base tags from name
                for (const [tag, regs] of Object.entries(flavorTags)) {
                    if (regs.some(r => r.test(p.name))) score += 1;
                }
                // user flavor prefs
                fl.forEach(tag => { if (flavorTags[tag]?.some(r => r.test(p.name))) score += 2; });
                // mood boost
                if (mood && moodBoost[mood]) {
                    for (const [tag, boost] of Object.entries(moodBoost[mood])) {
                        if (flavorTags[tag]?.some(r => r.test(p.name))) score += boost;
                    }
                }
                // vibe boost
                vb.forEach(v => {
                    const boosts = vibeBoost[v] || {};
                    for (const [tag, boost] of Object.entries(boosts)) {
                        if (flavorTags[tag]?.some(r => r.test(p.name))) score += boost;
                    }
                });
                return { ...p, score };
            });

            scores.sort((a, b) => b.score - a.score);
            const top = scores.slice(0, 3).filter(s => s.score > 0);

            console.log('Top recommendations:', top);
            const wrap = document.getElementById('suggestion-cards');
            wrap.innerHTML = '';
            if (top.length === 0) {
                document.getElementById('suggestions').classList.add('hidden');
                return;
            }
            top.forEach(s => {
                const div = document.createElement('div');
                div.className = 'rounded-xl bg-white/5 border border-white/10 p-3 flex items-center gap-3';
                div.innerHTML = `
                    <img src="${s.image}" alt="${s.name}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY3ZWVhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0OCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfjaY8L3RleHQ+PC9zdmc+'; this.onerror=null;" />
                    <div class="flex-1">
                        <div class="font-semibold">${s.name}</div>
                        <div class="text-sm text-white/70">‚Çπ${s.price.toFixed(2)}</div>
                        <div class="text-xs text-emerald-400">AI Recommended</div>
                    </div>
                    <button class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium transition" onclick="addToCart('${s.id}','${s.name.replace(/'/g, "\\'")}','${s.price}')">Add</button>
                `;
                wrap.appendChild(div);
            });
            document.getElementById('suggestions').classList.remove('hidden');
        }

        function startSlide(e) {
            const slider = document.getElementById('slideToPay');
            const handle = slider.querySelector('.slider-handle');
            const track = slider.querySelector('.slider-track');
            const rect = slider.getBoundingClientRect();
            sliding = true;
            slideData = { slider, handle, track, rect };
            const move = (evt) => {
                if (!sliding) return;
                const clientX = (evt.touches ? evt.touches[0].clientX : evt.clientX);
                let x = Math.max(0, Math.min(clientX - slideData.rect.left - (handle.offsetWidth / 2), slideData.rect.width - handle.offsetWidth));
                handle.style.left = `${x + 4}px`;
                const progress = (x + handle.offsetWidth) / slideData.rect.width;
                track.style.width = `${Math.max(0, Math.min(progress * 100, 100))}%`;
                if (progress >= 0.98) {
                    endSlide();
                    // Trigger payment
                    setTimeout(() => openRazorpay(), 50);
                }
            };
            const up = () => { endSlide(true); };
            window.addEventListener('mousemove', move, { passive: true });
            window.addEventListener('touchmove', move, { passive: true });
            window.addEventListener('mouseup', up, { once: true });
            window.addEventListener('touchend', up, { once: true });
        }

        function endSlide(reset = false) {
            if (!sliding || !slideData) return;
            sliding = false;
            const { handle, track } = slideData;
            if (reset) {
                handle.style.left = '4px';
                track.style.width = '0%';
            } else {
                handle.style.left = `${slideData.rect.width - handle.offsetWidth - 4}px`;
                track.style.width = '100%';
            }
            slideData = null;
        }

        function submitOrder() {
            // Check if email is verified first (temporarily disabled for testing)
            if (!emailVerified) {
                alert('Please verify your email first before placing an order.');
                return;
            }

            let btn = document.getElementById('place-order-btn');
            if (btn) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            document.getElementById('loader').classList.remove('hidden');

            let items = [];
            for (const [iceCreamId, item] of Object.entries(cart)) {
                items.push({
                    id: iceCreamId,
                    quantity: item.quantity
                });
            }

            if (items.length === 0) {
                alert("Please select at least one ice cream.");
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                document.getElementById('loader').classList.add('hidden');
                return;
            }

            fetch("{% url 'submit_order' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    table_id: "{{ table.id }}",
                    items: items
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data); // Debug log
                    if (data.status === 'success') {
                        let totalPrice = Object.values(cart).reduce((sum, item) => sum + item.quantity * item.price, 0);
                        // Use a valid UPI ID - replace with your actual UPI ID
                        let upiUrl = `upi://pay?pa=7383712117@yespop&pn=Ice cream shop&am=${totalPrice.toFixed(2)}&cu=INR&tn=Order Payment`;
                        // Use <a> tag for UPI redirection (better compatibility)
                        let a = document.createElement('a');
                        a.href = upiUrl;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        // Fallback message if UPI app does not open
                        setTimeout(() => {
                            document.getElementById('loader').classList.add('hidden');
                            window.location.href = '/order/success/?order_id=' + data.order_id;
                        }, 5000);
                    } else if (data.message && data.message.includes('Order placed but failed to sync with Firebase')) {
                        alert('Order placed! (But not synced to Firebase.) You can continue.');
                        setTimeout(() => {
                            document.getElementById('loader').classList.add('hidden');
                            window.location.href = '/order/success/?order_id=' + data.order_id;
                        }, 2000);
                    } else {
                        // Handle specific error messages
                        let errorMsg = "Failed to place order. Please try again.";
                        if (data.error) {
                            if (data.error === 'Email verification required') {
                                errorMsg = 'Please verify your email first before placing an order.';
                            } else if (data.error === 'Customer information missing') {
                                errorMsg = 'Please login with Google first.';
                            } else {
                                errorMsg = data.error;
                            }
                        }
                        alert(errorMsg);
                        if (btn) {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        document.getElementById('loader').classList.add('hidden');
                    }
                })
                .catch(err => {
                    console.error('Order submission error:', err);
                    alert("Failed to place order. Please try again.");
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    document.getElementById('loader').classList.add('hidden');
                });
        }

        function openUPI(app) {
            // Get the total price from the cart
            let totalPrice = Object.values(cart).reduce((sum, item) => sum + item.quantity * item.price, 0);
            // Use a valid UPI ID - replace with your actual UPI ID
            const upiId = '7383712117@yespop';  // Replace with your actual UPI ID
            const merchantName = 'Ice Cream Shop';
            let url = `upi://pay?pa=${upiId}&pn=${merchantName}&am=${totalPrice.toFixed(2)}&cu=INR&tn=Order Payment`;

            // App-specific modifications
            if (app === 'gpay') url += '&mc=1234';  // Merchant category code
            if (app === 'paytm') url += '&mode=02';  // Person to merchant
            if (app === 'phonepe') url += '&tr=ORDER' + Date.now();  // Transaction reference
            if (app === 'bhim') url += '&purpose=00';  // Purpose code

            let a = document.createElement('a');
            a.href = url;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function openRazorpay() {
            // Check if email is verified first (temporarily disabled for testing)
            if (!emailVerified) {
                alert('Please verify your email first before placing an order.');
                return;
            }

            let totalPrice = Object.values(cart).reduce((sum, item) => sum + item.quantity * item.price, 0);

            // First place the order in Django database
            let items = [];
            for (const [iceCreamId, item] of Object.entries(cart)) {
                items.push({
                    id: iceCreamId,
                    quantity: item.quantity
                });
            }

            if (items.length === 0) {
                alert("Please select at least one ice cream.");
                return;
            }

            // Place order first
            fetch("{% url 'submit_order' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    table_id: "{{ table.id }}",
                    items: items
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Show payment options modal
                        showPaymentOptions(data.order_id, totalPrice);
                    } else {
                        // Handle specific error messages
                        let errorMsg = "Failed to place order. Please try again.";
                        if (data.error) {
                            if (data.error === 'Email verification required') {
                                errorMsg = 'Please verify your email first before placing an order.';
                            } else if (data.error === 'Customer information missing') {
                                errorMsg = 'Please login with Google first.';
                            } else {
                                errorMsg = data.error;
                            }
                        }
                        alert(errorMsg);
                    }
                })
                .catch(err => {
                    console.error('Order placement error:', err);
                    alert("Failed to place order. Please try again.");
                });
        }

        function showPaymentOptions(orderId, totalPrice) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-md mx-4 w-full">
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold text-white mb-2">Choose Payment Method</h3>
                        <p class="text-white/70">Order #${orderId} - ‚Çπ${totalPrice.toFixed(2)}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="payWithUPI(${orderId}, ${totalPrice})" 
                                class="w-full p-4 bg-gradient-to-r from-green-600 to-green-500 rounded-lg text-white font-medium hover:from-green-500 hover:to-green-400 transition">
                            <div class="flex items-center justify-center space-x-3">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                                <span>Pay with UPI</span>
                            </div>
                            <div class="text-sm text-green-100 mt-1">Google Pay, PhonePe, Paytm, etc.</div>
                        </button>
                        
                        <button onclick="payWithRazorpay(${orderId}, ${totalPrice})" 
                                class="w-full p-4 bg-gradient-to-r from-blue-600 to-blue-500 rounded-lg text-white font-medium hover:from-blue-500 hover:to-blue-400 transition">
                            <div class="flex items-center justify-center space-x-3">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                                </svg>
                                <span>Pay with Card/Wallet</span>
                            </div>
                            <div class="text-sm text-blue-100 mt-1">Credit/Debit Card, Net Banking</div>
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" 
                            class="w-full mt-4 p-3 bg-white/10 border border-white/20 rounded-lg text-white hover:bg-white/20 transition">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function payWithUPI(orderId, totalPrice) {
            // Remove payment options modal
            document.querySelector('.fixed.inset-0').remove();

            // Check if email is verified (temporarily disabled for testing)
            if (!emailVerified) {
                alert('Please verify your email first');
                return;
            }

            // UPI Configuration
            const UPI_CONFIG = {
                merchantId: '7383712117@yespop',
                merchantName: 'Ice cream shop',
                currency: 'INR'
            };

            // Create payment reference
            const paymentRef = 'ORD' + orderId + '_' + Date.now();

            // Create UPI URL with proper formatting
            const upiParams = new URLSearchParams({
                pa: UPI_CONFIG.merchantId,
                pn: UPI_CONFIG.merchantName,
                am: totalPrice.toFixed(2),
                cu: UPI_CONFIG.currency,
                tn: `Order #${orderId} - Table {{ table.number }}`,
                tr: paymentRef
            });

            const upiUrl = `upi://pay?${upiParams.toString()}`;

            // Try to open UPI app
            try {
                const link = document.createElement('a');
                link.href = upiUrl;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Start payment monitoring
                startPaymentMonitoring(orderId, paymentRef);

            } catch (error) {
                console.error('UPI payment error:', error);
                alert('Unable to open UPI app. Please ensure you have a UPI app installed.');
            }
        }

        function startPaymentMonitoring(orderId, paymentRef) {
            // Show payment monitoring modal
            showPaymentMonitoring(orderId);

            // Start polling for payment status
            const pollInterval = setInterval(() => {
                fetch(`/payment/status/${orderId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            if (data.payment_status === 'completed') {
                                clearInterval(pollInterval);
                                showPaymentSuccess(orderId);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Payment status check error:', error);
                    });
            }, 3000); // Check every 3 seconds

            // Stop polling after 5 minutes
            setTimeout(() => {
                clearInterval(pollInterval);
                showPaymentTimeout(orderId);
            }, 300000); // 5 minutes
        }

        function showPaymentMonitoring(orderId) {
            const modal = document.createElement('div');
            modal.id = 'payment-monitoring-modal';
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Processing Payment</h3>
                        <p class="text-white/70 mb-4">Order #${orderId}</p>
                        <p class="text-white/60 text-sm mb-6">Please complete the payment in your UPI app. We're monitoring the transaction automatically.</p>
                        <div class="flex space-x-3">
                            <button onclick="cancelPaymentMonitoring()" class="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showPaymentSuccess(orderId) {
            // Remove monitoring modal
            const monitoringModal = document.getElementById('payment-monitoring-modal');
            if (monitoringModal) {
                monitoringModal.remove();
            }

            // Show success and redirect
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Payment Successful!</h3>
                        <p class="text-white/70 mb-4">Order #${orderId}</p>
                        <p class="text-white/60 text-sm mb-6">Your payment has been confirmed. Redirecting to order status...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = '/order/success/?order_id=' + orderId;
            }, 2000);
        }

        function showPaymentTimeout(orderId) {
            // Remove monitoring modal
            const monitoringModal = document.getElementById('payment-monitoring-modal');
            if (monitoringModal) {
                monitoringModal.remove();
            }

            // Show timeout message
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Payment Status Unknown</h3>
                        <p class="text-white/70 mb-4">Order #${orderId}</p>
                        <p class="text-white/60 text-sm mb-6">We couldn't detect your payment automatically. If you completed the payment, it may take a few minutes to reflect.</p>
                        <div class="flex space-x-3">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                                Close
                            </button>
                            <button onclick="checkPaymentManually(${orderId})" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white">
                                Check Status
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function cancelPaymentMonitoring() {
            const monitoringModal = document.getElementById('payment-monitoring-modal');
            if (monitoringModal) {
                monitoringModal.remove();
            }
        }

        function checkPaymentManually(orderId) {
            fetch(`/payment/status/${orderId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.payment_status === 'completed') {
                            showPaymentSuccess(orderId);
                        } else {
                            alert('Payment is still pending. Please wait or contact support.');
                        }
                    } else {
                        alert('Unable to check payment status. Please contact support.');
                    }
                })
                .catch(error => {
                    console.error('Payment status check error:', error);
                    alert('Error checking payment status. Please try again.');
                });
        }

        // Debug function for testing (remove in production)
        function debugLogin() {
            console.log('Debug login started...');

            fetch('/debug/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({})
            })
                .then(res => {
                    console.log('Debug login response status:', res.status);
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Debug login response data:', data);
                    if (data.success) {
                        currentUserEmail = data.email;
                        emailVerified = data.email_verified;

                        // Try to show order interface if function exists
                        if (typeof showOrderInterface === 'function') {
                            showOrderInterface({
                                name: data.name,
                                email: data.email,
                                picture: data.picture
                            });
                        }

                        // Hide debug button
                        const debugBtn = document.getElementById('debug-login');
                        if (debugBtn) {
                            debugBtn.style.display = 'none';
                        }

                        alert('Debug login successful! You can now place orders.');
                    } else {
                        console.error('Debug login failed:', data);
                        alert('Debug login failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Debug login error:', error);
                    alert('Debug login failed: ' + error.message);
                });
        }

        // Rate limiting variables
        let lastEmailSent = 0;
        let emailSendCount = 0;
        const EMAIL_COOLDOWN = 30000; // 30 seconds
        const MAX_EMAILS_PER_HOUR = 5;

        // Email login function (works with real email addresses)
        function emailLogin() {
            const email = document.getElementById('customer-email-input').value.trim();
            const name = document.getElementById('customer-name-input').value.trim();

            // Validate inputs
            if (!email || !name) {
                alert('Please enter both email and name');
                return;
            }

            // Rate limiting check
            const now = Date.now();
            if (now - lastEmailSent < EMAIL_COOLDOWN) {
                const remainingTime = Math.ceil((EMAIL_COOLDOWN - (now - lastEmailSent)) / 1000);
                alert(`Please wait ${remainingTime} seconds before requesting another verification email.`);
                return;
            }

            // Check hourly limit
            const oneHourAgo = now - (60 * 60 * 1000);
            if (emailSendCount >= MAX_EMAILS_PER_HOUR && lastEmailSent > oneHourAgo) {
                alert('Too many verification emails sent. Please try again later.');
                return;
            }

            // Disable button temporarily
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Sending...';

            setTimeout(() => {
                button.disabled = false;
                button.textContent = originalText;
            }, EMAIL_COOLDOWN);

            if (!isValidEmail(email)) {
                console.log('Email validation failed for:', email);
                alert('Please enter a valid email address. Make sure it includes @ and a domain (e.g., user@example.com)');
                return;
            }

            console.log('Email login started for:', email);

            // Set current user data
            currentUserEmail = email;
            emailVerified = false; // Will need to verify email

            // Call backend to send real verification email
            fetch('/customer/google-login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    email: email,
                    name: name,
                    manual_login: true
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Update rate limiting
                        lastEmailSent = Date.now();
                        emailSendCount++;

                        // Show email verification modal
                        document.getElementById('verification-email').textContent = email;
                        document.getElementById('google-signin-section').classList.add('hidden');
                        document.getElementById('email-verification-modal').classList.remove('hidden');
                        document.getElementById('email-verification-modal').classList.add('flex');

                        alert('Verification email sent to ' + email + '\\nPlease check your email for the 6-digit code.');
                    } else {
                        alert('Failed to send verification email: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Email login error:', error);
                    // Fallback for testing
                    document.getElementById('verification-email').textContent = email;
                    document.getElementById('google-signin-section').classList.add('hidden');
                    document.getElementById('email-verification-modal').classList.remove('hidden');
                    document.getElementById('email-verification-modal').classList.add('flex');
                    alert('Verification email sent to ' + email + '\\nPlease check your email for the 6-digit code.');
                });
        }

        // Email validation helper (more lenient)
        function isValidEmail(email) {
            // More comprehensive email validation
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

            // Basic checks first
            if (!email || email.length < 5) return false;
            if (!email.includes('@')) return false;
            if (!email.includes('.')) return false;
            if (email.startsWith('@') || email.endsWith('@')) return false;
            if (email.startsWith('.') || email.endsWith('.')) return false;

            return emailRegex.test(email);
        }

        // Manual login function removed for production

        // Simple debug login that just sets variables
        function simpleDebugLogin() {
            console.log('Simple debug login started...');

            // Set the variables directly
            currentUserEmail = 'test@example.com';
            emailVerified = true;

            // Hide debug buttons
            const debugDiv = document.getElementById('debug-login');
            if (debugDiv) {
                debugDiv.style.display = 'none';
            }

            alert('Simple debug login successful! You can now place orders.');
        }

        function payWithRazorpay(orderId, totalPrice) {
            console.log('Initializing Razorpay payment...', { orderId, totalPrice });

            // Remove payment options modal
            document.querySelector('.fixed.inset-0').remove();

            // Validate Razorpay key
            const razorpayKey = "{{ razorpay_key }}";
            console.log('Razorpay key:', razorpayKey);

            if (!razorpayKey || razorpayKey === '') {
                alert('Razorpay configuration error. Please contact support.');
                console.error('Razorpay key not configured');
                return;
            }

            // Check if Razorpay is loaded
            if (typeof Razorpay === 'undefined') {
                console.error('Razorpay library not loaded. Checking script...');
                const razorpayScript = document.querySelector('script[src*="razorpay"]');
                console.log('Razorpay script element:', razorpayScript);
                alert('Payment system not loaded. Please refresh the page and try again.');
                return;
            }

            console.log('Razorpay library loaded successfully');

            // Open Razorpay
            let options = {
                "key": razorpayKey,
                "amount": Math.round(totalPrice * 100), // Amount in paise
                "currency": "INR",
                "name": "Ice Cream Shop",
                "description": `Order #${orderId}`,
                "image": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY3ZWVhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzMiIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPvCfjaY8L3RleHQ+PC9zdmc+",
                "handler": function (response) {
                    console.log('Razorpay payment successful:', response);

                    // Verify payment on backend
                    fetch('/payment/verify/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            order_id: orderId,
                            payment_reference: response.razorpay_payment_id,
                            payment_method: 'Razorpay'
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                console.log('Payment verified successfully');
                                // Redirect to success page
                                window.location.href = '/order/success/?order_id=' + orderId;
                            } else {
                                console.error('Payment verification failed:', data);
                                alert('Payment successful but verification failed. Please contact support.');
                            }
                        })
                        .catch(error => {
                            console.error('Payment verification error:', error);
                            alert('Payment successful but verification failed. Please contact support.');
                        });
                },
                "prefill": {
                    "name": customerName || "Customer",
                    "email": customerEmail || "customer@example.com",
                    "contact": "9999999999"
                },
                "theme": {
                    "color": "#4F46E5"
                },
                "modal": {
                    "ondismiss": function () {
                        console.log('Razorpay payment cancelled');
                        // You can add handling for cancelled payments here
                    }
                }
            };

            try {
                console.log('Creating Razorpay instance with options:', options);
                let rzp = new Razorpay(options);

                // Add error event listener
                rzp.on('payment.failed', function (response) {
                    console.error('Razorpay payment failed:', response.error);
                    alert('Payment failed: ' + response.error.description);
                });

                console.log('Opening Razorpay checkout...');
                rzp.open();
            } catch (error) {
                console.error('Razorpay initialization error:', error);
                alert('Payment system error: ' + error.message + '. Please try again or contact support.');
            }
        }

        function showPaymentConfirmation(orderId, amount) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Complete Payment</h3>
                        <p class="text-white/70 mb-2">Order #${orderId}</p>
                        <p class="text-white/70 mb-4">Amount: ‚Çπ${amount.toFixed(2)}</p>
                        <p class="text-white/60 text-sm mb-6">Complete the payment in your UPI app and return here.</p>
                        <div class="flex space-x-3">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white">
                                Cancel
                            </button>
                            <button onclick="confirmPayment(${orderId})" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-white">
                                Payment Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmPayment(orderId) {
            // Remove payment modal
            document.querySelector('.fixed.inset-0').remove();

            // Redirect to success page
            window.location.href = '/order/success/?order_id=' + orderId;
        }
    </script>


</body>

</html>