{% extends 'admin_base.html' %}

{% block title %}Table Management{% endblock %}
{% block page_title %}Table Management{% endblock %}
{% block page_description %}Manage your restaurant tables and QR codes{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center space-x-4">
        <div class="bg-white rounded-lg px-4 py-2 shadow-sm">
            <span class="text-sm text-gray-600">Total Tables: </span>
            <span class="font-semibold text-gray-800">{{ tables.count }}</span>
        </div>
        <div class="bg-white rounded-lg px-4 py-2 shadow-sm">
            <span class="text-sm text-gray-600">Active: </span>
            <span class="font-semibold text-green-600">{{ tables.count }}</span>
        </div>
    </div>
    
    <div class="flex space-x-3">
        <button onclick="testQRGeneration()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition">
            <i class="fas fa-qrcode mr-2"></i>Test QR
        </button>
        <a href="{% url 'add_table' %}" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition flex items-center space-x-2">
            <i class="fas fa-plus"></i>
            <span>Add New Table</span>
        </a>
    </div>
</div>

<!-- Tables Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for table in tables %}
    <div class="bg-white rounded-xl shadow-sm overflow-hidden card-hover transition-all duration-200">
        <!-- Table Header -->
        <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-6 text-center">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm">
                <i class="fas fa-table text-2xl text-blue-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Table {{ table.number }}</h3>
            <p class="text-sm text-gray-600">{{ table.seats|default:4 }} seats</p>
        </div>
        
        <!-- Table Details -->
        <div class="p-6">
            <!-- Status -->
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm text-gray-600">Status</span>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                    Available
                </span>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4 mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="text-center">
                    <p class="text-xs text-gray-500">Today's Orders</p>
                    <p class="font-semibold text-gray-800">{{ table.orders_today|default:0 }}</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500">Revenue</p>
                    <p class="font-semibold text-gray-800">₹{{ table.revenue_today|default:0|floatformat:0 }}</p>
                </div>
            </div>
            
            <!-- QR Code Section -->
            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-blue-800">QR Code</span>
                    <div class="flex space-x-2">
                        <button onclick="previewQR('{{ table.id }}', '{{ table.number }}', '{{ table.token }}')" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button onclick="generateQR('{{ table.id }}', '{{ table.token }}')" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-sync-alt"></i> Regenerate
                        </button>
                    </div>
                </div>
                <div class="text-center">
                    <div class="w-20 h-20 bg-white rounded-lg mx-auto mb-2 flex items-center justify-center cursor-pointer" onclick="previewQR('{{ table.id }}', '{{ table.number }}', '{{ table.token }}')">
                        <canvas id="qr-{{ table.id }}" width="80" height="80" class="hidden" data-token="{{ table.token }}"></canvas>
                        <i class="fas fa-qrcode text-2xl text-gray-400 qr-placeholder"></i>
                    </div>
                    <div class="flex justify-center space-x-2">
                        <button onclick="downloadQR('{{ table.id }}', '{{ table.token }}')" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button onclick="printQR('{{ table.id }}', '{{ table.token }}')" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex space-x-2">
                <a href="{% url 'edit_table' table.pk %}" 
                   class="flex-1 px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg text-sm font-medium transition text-center">
                    <i class="fas fa-edit mr-1"></i>Edit
                </a>
                <button onclick="viewOrders('{{ table.id }}')" 
                        class="flex-1 px-3 py-2 bg-green-50 hover:bg-green-100 text-green-600 rounded-lg text-sm font-medium transition">
                    <i class="fas fa-list mr-1"></i>Orders
                </button>
                <button onclick="deleteTable({{ table.pk }}, '{{ table.number }}')" 
                        class="px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-sm font-medium transition">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <!-- Empty State -->
    <div class="col-span-full">
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-table text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-800 mb-2">No Tables</h3>
            <p class="text-gray-600 mb-6">Get started by adding your first table</p>
            <a href="{% url 'add_table' %}" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                Add First Table
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Quick Stats -->
{% if tables %}
<div class="mt-8 bg-white rounded-xl shadow-sm p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Table Statistics</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Total Tables -->
        <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg">
            <i class="fas fa-table text-2xl text-blue-500 mb-2"></i>
            <h4 class="font-medium text-gray-800">Total Tables</h4>
            <p class="text-2xl font-bold text-gray-800">{{ tables.count }}</p>
        </div>
        
        <!-- Most Active -->
        <div class="text-center p-4 bg-gradient-to-br from-green-50 to-blue-50 rounded-lg">
            <i class="fas fa-fire text-2xl text-green-500 mb-2"></i>
            <h4 class="font-medium text-gray-800">Most Active</h4>
            <p class="text-sm text-gray-600">Table {{ most_active_table|default:"N/A" }}</p>
        </div>
        
        <!-- Average Orders -->
        <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg">
            <i class="fas fa-chart-bar text-2xl text-purple-500 mb-2"></i>
            <h4 class="font-medium text-gray-800">Avg Orders/Table</h4>
            <p class="text-sm text-gray-600">{{ avg_orders_per_table|floatformat:1|default:"0" }}</p>
        </div>
        
        <!-- Total Capacity -->
        <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-red-50 rounded-lg">
            <i class="fas fa-users text-2xl text-orange-500 mb-2"></i>
            <h4 class="font-medium text-gray-800">Total Capacity</h4>
            <p class="text-sm text-gray-600">{{ total_capacity|default:"N/A" }} seats</p>
        </div>
    </div>
</div>

<!-- QR Code Management -->
<div class="mt-8 bg-white rounded-xl shadow-sm p-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">QR Code Management</h3>
        <div class="flex space-x-2">
            <button onclick="downloadAllQR()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition">
                <i class="fas fa-download mr-2"></i>Download All QR Codes
            </button>
            <button onclick="regenerateAllQR()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                <i class="fas fa-sync-alt mr-2"></i>Regenerate All
            </button>
        </div>
    </div>
    
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-center space-x-2 mb-2">
            <i class="fas fa-info-circle text-blue-600"></i>
            <h4 class="font-medium text-blue-800">QR Code Instructions</h4>
        </div>
        <ul class="text-sm text-blue-700 space-y-1">
            <li>• Each table has a unique QR code that customers scan to place orders</li>
            <li>• Print and place QR codes on each table for easy customer access</li>
            <li>• Regenerate QR codes if you need to change table configurations</li>
            <li>• Download all QR codes as a ZIP file for easy printing</li>
        </ul>
    </div>
</div>
{% endif %}
<!-- QR Code Preview Modal -->
<div id="qr-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">QR Code Preview</h3>
                <button onclick="closeQRModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6 text-center">
            <div id="qr-preview-content">
                <!-- QR code will be inserted here -->
            </div>
            <div class="mt-4">
                <h4 class="font-semibold text-gray-800" id="qr-table-title">Table #</h4>
                <p class="text-sm text-gray-600" id="qr-table-url">Scan to order from this table</p>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button onclick="downloadQRFromModal()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium transition hover:bg-blue-700">
                    <i class="fas fa-download mr-2"></i>Download
                </button>
                <button onclick="printQRFromModal()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-medium transition hover:bg-green-700">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
function deleteTable(id, number) {
    if (confirm(`Are you sure you want to delete Table ${number}? This action cannot be undone.`)) {
        fetch(`/panel/tables/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete table: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete table');
        });
    }
}

let currentTableId = null;

function generateQR(tableId, tableToken) {
    console.log('Generating QR for table:', tableId, 'with token:', tableToken);
    
    // Check if QRCode library is loaded
    if (typeof QRCode === 'undefined') {
        console.error('QRCode library not loaded, using fallback');
        generateSimpleQR(tableId, tableToken);
        return;
    }
    
    // Generate QR code for the table using token
    const urlParam = tableToken || tableId;
    const tableUrl = `${window.location.origin}/table/${urlParam}/`;
    const canvas = document.getElementById(`qr-${tableId}`);
    
    if (!canvas) {
        console.error('Canvas not found for table:', tableId);
        return;
    }
    
    console.log('Generating QR for URL:', tableUrl);
    
    QRCode.toCanvas(canvas, tableUrl, {
        width: 80,
        height: 80,
        margin: 1,
        color: {
            dark: '#1f2937',
            light: '#ffffff'
        }
    }, function (error) {
        if (error) {
            console.error('QR Code generation error:', error);
            console.log('Falling back to simple QR generation');
            generateSimpleQR(tableId, tableToken);
        } else {
            console.log('QR Code generated successfully for table:', tableId);
            // Hide placeholder and any existing fallback image
            const placeholder = canvas.parentElement.querySelector('.qr-placeholder');
            if (placeholder) placeholder.style.display = 'none';
            
            const existingImg = canvas.parentElement.querySelector(`#qr-img-${tableId}`);
            if (existingImg) existingImg.style.display = 'none';
            
            canvas.classList.remove('hidden');
            canvas.style.display = 'block';
        }
    });
}

function previewQR(tableId, tableNumber, tableToken) {
    console.log('Previewing QR for table:', tableId, tableNumber, 'with token:', tableToken);
    
    currentTableId = tableId;
    const urlParam = tableToken || tableId;
    const tableUrl = `${window.location.origin}/table/${urlParam}/`;
    
    console.log('Preview URL:', tableUrl);
    
    // Create a larger QR code for preview using API
    const previewContainer = document.getElementById('qr-preview-content');
    if (!previewContainer) {
        console.error('Preview container not found');
        return;
    }
    
    previewContainer.innerHTML = '<div class="text-blue-600">Generating QR code...</div>';
    
    // Try to create a larger QR code using API
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(tableUrl)}`;
    
    const img = document.createElement('img');
    img.src = qrUrl;
    img.alt = `QR Code for Table ${tableNumber}`;
    img.className = 'mx-auto rounded';
    img.style.maxWidth = '200px';
    img.style.maxHeight = '200px';
    
    img.onload = function() {
        console.log('Preview QR loaded successfully');
        previewContainer.innerHTML = '';
        previewContainer.appendChild(img);
        
        // Update modal content
        document.getElementById('qr-table-title').textContent = `Table ${tableNumber}`;
        document.getElementById('qr-table-url').textContent = tableUrl;
        
        // Show modal
        document.getElementById('qr-preview-modal').classList.remove('hidden');
        document.getElementById('qr-preview-modal').classList.add('flex');
    };
    
    img.onerror = function() {
        console.error('Preview QR failed, trying Google Charts...');
        // Fallback to Google Charts
        const fallbackUrl = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(tableUrl)}`;
        
        const fallbackImg = document.createElement('img');
        fallbackImg.src = fallbackUrl;
        fallbackImg.alt = `QR Code for Table ${tableNumber}`;
        fallbackImg.className = 'mx-auto rounded';
        fallbackImg.style.maxWidth = '200px';
        fallbackImg.style.maxHeight = '200px';
        
        fallbackImg.onload = function() {
            console.log('Preview QR loaded with Google Charts');
            previewContainer.innerHTML = '';
            previewContainer.appendChild(fallbackImg);
            
            // Update modal content
            document.getElementById('qr-table-title').textContent = `Table ${tableNumber}`;
            document.getElementById('qr-table-url').textContent = tableUrl;
            
            // Show modal
            document.getElementById('qr-preview-modal').classList.remove('hidden');
            document.getElementById('qr-preview-modal').classList.add('flex');
        };
        
        fallbackImg.onerror = function() {
            console.error('All preview QR APIs failed');
            previewContainer.innerHTML = `
                <div class="text-center p-4">
                    <i class="fas fa-qrcode text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 mb-2">QR Code Preview Unavailable</p>
                    <p class="text-sm text-gray-500">Table URL: ${tableUrl}</p>
                    <button onclick="navigator.clipboard.writeText('${tableUrl}')" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-sm">
                        Copy URL
                    </button>
                </div>
            `;
            
            // Update modal content
            document.getElementById('qr-table-title').textContent = `Table ${tableNumber}`;
            document.getElementById('qr-table-url').textContent = tableUrl;
            
            // Show modal
            document.getElementById('qr-preview-modal').classList.remove('hidden');
            document.getElementById('qr-preview-modal').classList.add('flex');
        };
    };
}

function closeQRModal() {
    document.getElementById('qr-preview-modal').classList.add('hidden');
    document.getElementById('qr-preview-modal').classList.remove('flex');
}

function downloadQR(tableId, tableToken) {
    const canvas = document.getElementById(`qr-${tableId}`);
    if (canvas && !canvas.classList.contains('hidden')) {
        // Download the generated QR code
        const link = document.createElement('a');
        link.download = `table_${tableId}_qr.png`;
        link.href = canvas.toDataURL();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('QR code downloaded!', 'success');
    } else {
        // Generate QR code first, then download
        previewQR(tableId, tableId, tableToken);
    }
}

function downloadQRFromModal() {
    if (currentTableId) {
        const canvas = document.getElementById('qr-preview-canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = `table_${currentTableId}_qr.png`;
            link.href = canvas.toDataURL();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('QR code downloaded!', 'success');
        }
    }
}

function printQR(tableId, tableToken) {
    previewQR(tableId, tableId, tableToken);
    setTimeout(() => {
        printQRFromModal();
    }, 500);
}

function printQRFromModal() {
    if (currentTableId) {
        const canvas = document.getElementById('qr-preview-canvas');
        if (canvas) {
            const printWindow = window.open('', '_blank');
            const tableNumber = document.getElementById('qr-table-title').textContent;
            const tableUrl = document.getElementById('qr-table-url').textContent;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR Code - ${tableNumber}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 20px;
                            margin: 0;
                        }
                        .qr-container {
                            border: 2px solid #333;
                            padding: 20px;
                            display: inline-block;
                            margin: 20px;
                        }
                        h1 { margin: 10px 0; }
                        p { margin: 5px 0; font-size: 12px; color: #666; }
                        .instructions {
                            margin-top: 15px;
                            font-size: 14px;
                            color: #333;
                        }
                    </style>
                </head>
                <body>
                    <div class="qr-container">
                        <h1>${tableNumber}</h1>
                        <img src="${canvas.toDataURL()}" alt="QR Code" />
                        <div class="instructions">
                            <p><strong>Scan to Order</strong></p>
                            <p>Point your phone camera at this QR code</p>
                            <p>to access our menu and place your order</p>
                        </div>
                        <p style="margin-top: 15px; font-size: 10px;">${tableUrl}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    }
}

function downloadAllQR() {
    // Create download link for all QR codes
    const link = document.createElement('a');
    link.href = `/panel/tables/qr/download-all/`;
    link.download = `all_table_qr_codes.zip`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Downloading all QR codes...', 'info');
}

function regenerateAllQR() {
    if (confirm('Are you sure you want to regenerate all QR codes? This will update all table QR codes.')) {
        fetch('/panel/tables/qr/regenerate-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('All QR codes regenerated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Failed to regenerate QR codes: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to regenerate QR codes');
        });
    }
}

function viewOrders(tableId) {
    // Redirect to orders filtered by table
    window.location.href = `/panel/dashboard/?table=${tableId}`;
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
        type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
        'bg-blue-100 text-blue-800 border border-blue-200'
    }`;
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function testQRGeneration() {
    console.log('=== QR Generation Test ===');
    console.log('QRCode library available:', typeof QRCode !== 'undefined');
    console.log('Current URL:', window.location.origin);
    
    const tableCanvases = document.querySelectorAll('canvas[id^="qr-"]');
    console.log('Found table canvases:', tableCanvases.length);
    
    // Debug: Check what's actually in the DOM
    tableCanvases.forEach(canvas => {
        const tableId = canvas.id.replace('qr-', '');
        const container = canvas.parentElement;
        const images = container.querySelectorAll('img');
        console.log(`Table ${tableId} - Canvas:`, canvas.style.display, 'Images:', images.length);
        images.forEach((img, i) => {
            console.log(`  Image ${i}:`, img.src, 'Display:', img.style.display);
        });
    });
    
    if (tableCanvases.length === 0) {
        showNotification('No tables found to generate QR codes for', 'error');
        return;
    }
    
    // Force regenerate all QR codes
    showNotification('Regenerating all QR codes...', 'info');
    
    if (typeof QRCode !== 'undefined') {
        console.log('Using QRCode library');
        generateAllQRCodes();
    } else {
        console.log('Using fallback QR generation');
        showFallbackQRCodes();
    }
}

// Auto-generate QR codes when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting QR generation...');
    
    // Debug: Check if tables exist
    const tableCanvases = document.querySelectorAll('canvas[id^="qr-"]');
    console.log('Table canvases found on page:', tableCanvases.length);
    
    if (tableCanvases.length === 0) {
        console.log('No table canvases found - QR generation skipped');
        return;
    }
    
    // First, try to generate QR codes immediately using fallback
    showFallbackQRCodes();
    
    // Then wait for the library to load and try again with better quality
    setTimeout(() => {
        if (typeof QRCode !== 'undefined') {
            console.log('QRCode library loaded, upgrading to high-quality QR codes...');
            generateAllQRCodes();
        } else {
            console.log('QRCode library not available, keeping fallback QR codes');
        }
    }, 2000);
});

function showFallbackQRCodes() {
    console.log('Using fallback QR generation...');
    // Show fallback QR codes using Google Charts API - only for canvas elements
    const tableCanvases = document.querySelectorAll('canvas[id^="qr-"]');
    
    console.log('Found table canvases:', tableCanvases.length);
    
    tableCanvases.forEach(canvas => {
        const tableId = canvas.id.replace('qr-', '');
        const tableToken = canvas.dataset.token;
        if (tableId && !isNaN(tableId)) { // Only process numeric table IDs
            console.log('Generating QR for table:', tableId, 'with token:', tableToken);
            generateSimpleQR(tableId, tableToken);
        }
    });
}

function generateAllQRCodes() {
    // Generate QR codes for all tables
    const tableCanvases = document.querySelectorAll('canvas[id^="qr-"]');
    console.log('Found', tableCanvases.length, 'table canvases');
    
    if (tableCanvases.length === 0) {
        console.log('No table canvases found');
        return;
    }
    
    tableCanvases.forEach((canvas, index) => {
        const tableId = canvas.id.replace('qr-', '');
        const tableToken = canvas.dataset.token;
        if (tableId && !isNaN(tableId)) { // Only process numeric table IDs
            console.log('Generating QR for table:', tableId, 'with token:', tableToken);
            // Add a small delay between generations to avoid overwhelming
            setTimeout(() => {
                if (typeof QRCode !== 'undefined') {
                    generateQR(tableId, tableToken);
                } else {
                    generateSimpleQR(tableId, tableToken);
                }
            }, index * 100);
        }
    });
}

// Simple QR code fallback using multiple APIs
function generateSimpleQR(tableId, tableToken) {
    // Use token if provided, otherwise fall back to tableId (for backward compatibility)
    const urlParam = tableToken || tableId;
    const tableUrl = `${window.location.origin}/table/${urlParam}/`;
    
    const canvas = document.getElementById(`qr-${tableId}`);
    const container = canvas.parentElement;
    
    // Check if QR image already exists
    const existingImg = container.querySelector(`img[alt*="Table ${tableId}"]`);
    if (existingImg) {
        console.log('QR image already exists for table:', tableId);
        return;
    }
    
    // Try multiple QR APIs in order of preference
    const qrApis = [
        `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(tableUrl)}`,
        `https://chart.googleapis.com/chart?chs=80x80&cht=qr&chl=${encodeURIComponent(tableUrl)}`,
        // Fallback: create a simple text-based QR placeholder
        null
    ];
    
    let currentApiIndex = 0;
    
    function tryNextApi() {
        if (currentApiIndex >= qrApis.length) {
            // All APIs failed, create a text-based fallback
            createTextFallback();
            return;
        }
        
        const qrUrl = qrApis[currentApiIndex];
        if (!qrUrl) {
            createTextFallback();
            return;
        }
        
        console.log(`Trying QR API ${currentApiIndex + 1} for table ${tableId}:`, qrUrl);
        
        // Create image element
        const img = document.createElement('img');
        img.src = qrUrl;
        img.alt = `QR Code for Table ${tableId}`;
        img.className = 'w-20 h-20 rounded mx-auto';
        img.style.display = 'block';
        img.style.maxWidth = '80px';
        img.style.maxHeight = '80px';
        img.id = `qr-img-${tableId}`;
        
        // Add error handling
        img.onerror = function() {
            console.error(`QR API ${currentApiIndex + 1} failed for table ${tableId}, trying next...`);
            this.remove();
            currentApiIndex++;
            tryNextApi();
        };
        
        img.onload = function() {
            console.log(`QR image loaded successfully for table ${tableId} using API ${currentApiIndex + 1}`);
            // Hide canvas and placeholder
            canvas.style.display = 'none';
            const placeholder = container.querySelector('.qr-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
                placeholder.remove();
            }
        };
        
        // Clear container and add image
        const existingImages = container.querySelectorAll('img, div.qr-text-fallback');
        existingImages.forEach(el => el.remove());
        
        container.appendChild(img);
    }
    
    function createTextFallback() {
        console.log('All QR APIs failed, creating text fallback for table:', tableId);
        
        // Create a text-based fallback
        const fallbackDiv = document.createElement('div');
        fallbackDiv.className = 'qr-text-fallback w-20 h-20 bg-blue-100 rounded flex flex-col items-center justify-center text-xs text-blue-800 border-2 border-blue-300';
        fallbackDiv.innerHTML = `
            <i class="fas fa-qrcode text-lg mb-1"></i>
            <span>Table ${tableId}</span>
            <span class="text-xs">QR Code</span>
        `;
        fallbackDiv.style.cursor = 'pointer';
        fallbackDiv.onclick = () => {
            // Copy URL to clipboard when clicked
            navigator.clipboard.writeText(tableUrl).then(() => {
                showNotification('Table URL copied to clipboard!', 'success');
            }).catch(() => {
                prompt('Copy this URL:', tableUrl);
            });
        };
        
        // Hide canvas and placeholder
        canvas.style.display = 'none';
        const placeholder = container.querySelector('.qr-placeholder');
        if (placeholder) {
            placeholder.style.display = 'none';
            placeholder.remove();
        }
        
        // Clear container and add fallback
        const existingElements = container.querySelectorAll('img, div.qr-text-fallback');
        existingElements.forEach(el => el.remove());
        
        container.appendChild(fallbackDiv);
        
        console.log('Text fallback created for table:', tableId);
    }
    
    // Start trying APIs
    tryNextApi();
}
</script>
{% endblock %}